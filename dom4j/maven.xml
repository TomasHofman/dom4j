<project default="dist:build-bin" 
         xmlns:j="jelly:core" 
         xmlns:ant="jelly:ant"
         xmlns:doc="doc"
         xmlns:maven="jelly:maven" >

    <!-- define the classpath used to run examples -->
    <goal name="create-classpath" prereqs="java:compile,test:compile">
        <path id="test.classpath">
            <pathelement path="${maven.build.dest}"/>
            <pathelement path="target/classes"/>
            <pathelement path="target/test-classes"/>
            <pathelement path="src/"/>
            <path refid="maven.dependency.classpath"/>
        </path>
    </goal>

    <postGoal name="clean:clean">
        <delete>
            <fileset dir="${basedir}" includes="junit*.properties"/>
        </delete>
    </postGoal>

    <goal name="dom4j-clover:register">
        <doc:registerReport name="Clover" 
                            pluginName="dom4j-clover" 
                            link="clover/index"
                            description="Clover test coverage report."/>
    </goal>
  
    <goal name="dom4j-clover:deregister">
        <doc:deregisterReport name="Clover"/>
    </goal>

    <goal name="dom4j-clover:report">
        <attainGoal name="test:compile"/>

        <ant:taskdef resource="clovertasks">
            <classpath>
                <pathelement path="${basedir}/lib/tools/clover-1.3-rc4.jar"/>
            </classpath>
        </ant:taskdef>    
        <ant:typedef resource="clovertypes">
            <classpath>
                <pathelement path="${basedir}/lib/tools/clover-1.3-rc2.jar"/>
            </classpath>
        </ant:typedef>

        <ant:mkdir dir="${basedir}/target/clover/database" />
        <ant:clover-setup initstring="${basedir}/target/clover/database/dom4j_clover_coverage.db">
            <j:forEach var="srcDir" items="${srcDirs}">
                <ant:fileset dir="${srcDir}">
                    <ant:include name="org/dom4j/**"/>
                </ant:fileset>
            </j:forEach>
            <files excludes="org/xml/sax/**,org/dom4j/io/aelfred/**,org/dom4j/io/aelfred2/**" />
        </ant:clover-setup>

        <!-- Make sure that the report is generated whether the tests pass or not -->
        <j:set var="ignoreTestFailureOld" value="${maven.test.failure.ignore}"/>
        <j:set var="junitForkOld" value="${maven.junit.fork}"/>

        <!-- Customize settings for clover report generation -->     
        <j:set var="maven.test.failure.ignore" scope="parent" value="true"/>
        <j:set var="maven.junit.fork" scope="parent" value="true"/>
        <j:set var="tmp" value="${basedir}/target/clover/classes"/>
        <j:set var="mavenBuildDestJavaOld" value="${pom.getPluginContext('maven-java-plugin').getVariable('maven.build.dest')}"/>
        ${pom.getPluginContext('maven-java-plugin').setVariable('maven.build.dest',tmp)}
        <j:set var="mavenBuildDestTestOld" value="${pom.getPluginContext('maven-test-plugin').getVariable('maven.build.dest')}"/>
        ${pom.getPluginContext('maven-test-plugin').setVariable('maven.build.dest',tmp)}
    
        <attainGoal name="test:test"/>

	<ant:clover-report>
            <current outfile="${maven.docs.dest}/clover" 
                     title="${pom.name} - ${pom.currentVersion}">
                <format type="html" orderBy="${maven.clover.orderBy}"/>
            </current>
        </ant:clover-report>

        <!-- restore original settings -->
        ${pom.getPluginContext('maven-test-plugin').setVariable('maven.build.dest',mavenBuildDestTestOld)}
        ${pom.getPluginContext('maven-java-plugin').setVariable('maven.build.dest',mavenBuildDestJavaOld)}

        ${pom.getContext().removeVariable('build.compiler')}
    
        <j:set var="maven.test.failure.ignore" scope="parent" value="${ignoreTestFailureOld}"/>
        <j:set var="maven.junit.fork" scope="parent" value="${junitForkOld}"/>

    </goal>

    <postGoal name="dist:prepare-bin-filesystem">
        <ant:copy todir="${maven.dist.bin.assembly.dir}">
            <fileset dir=".">
                <include name="build.xml" />
                <include name="maven.xml" />
                <include name="project.properties" />
                <include name="project.xml" />
                <include name="LICENSE*" />
                <include name="lib/**" />
                <include name="src/**" />
                <include name="xdocs/**" />
                <include name="xml/**" />
            </fileset>
        </ant:copy>
        <ant:copy todir="${maven.dist.bin.assembly.dir}/docs">
            <fileset dir="target/docs"/>
        </ant:copy>
    </postGoal>

    <postGoal name="dist:prepare-src-filesystem">
        <ant:copy todir="${maven.dist.src.assembly.dir}/lib">
            <fileset dir="lib"/>
        </ant:copy>
    </postGoal>

    <preGoal name="test:test">
        <ant:property name="test.dest"
            value="${pom.getPluginContext('maven-test-plugin').getVariable('maven.test.dest')}"/>

        <ant:path id="test.extra.classpath">
            <pathelement location="."/>
        </ant:path>

        <maven:addPath id="maven.dependency.classpath"
                       refid="test.extra.classpath"/>
    </preGoal>

    <preGoal name="site">
        <attainGoal name="docbook:transform"/>
    </preGoal>

    <preGoal name="xdoc:jelly-transform">
        <attainGoal name="faq"/>
    </preGoal>

    <postGoal name="xdoc:register-reports">
        <attainGoal name="maven-checkstyle-plugin:deregister"/>
        <attainGoal name="dom4j-clover:register"/>
    </postGoal>

</project>
